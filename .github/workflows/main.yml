# 自动 / 手动 编译 Android APK 的 GitHub Actions 工作流
# 说明：这个工作流忽略仓库里已有的动作脚本（不会引用或修改它们），
#       在 push 到 main、PR 到 main 时自动触发，同时支持手动触发（workflow_dispatch）。
#       它会：
#         - 设置 JDK
#         - 缓存 Gradle
#         - 安装 Android command-line tools、platform-tools、指定 platform 和 build-tools
#         - 构建 debug APK（并可选地构建并签名 release APK，当你配置签名 secret 时）
#         - 上传构建产物为 workflow artifact
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch: {}

name: Android CI - Build APK

permissions:
  contents: read
  actions: read
  id-token: write

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk
      GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx3g"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java (Temurin 11)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            .gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Install tools for Android SDK (wget, unzip)
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip

      - name: Install Android SDK command-line tools and required packages
        run: |
          set -e
          SDK_ROOT="${ANDROID_SDK_ROOT}"
          mkdir -p "${SDK_ROOT}"
          cd "${SDK_ROOT}"
          # 下载最新 commandlinetools（版本号可能更新，若失效请替换为最新 URL）
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
          unzip -q cmdline-tools.zip -d cmdline-tools
          mkdir -p cmdline-tools/latest
          # 有些 zip 解压结构不同，保证二级目录为 latest
          if [ -d cmdline-tools/cmdline-tools ]; then
            mv cmdline-tools/cmdline-tools/* cmdline-tools/latest/ || true
            rmdir --ignore-fail-on-non-empty cmdline-tools/cmdline-tools || true
          else
            mv cmdline-tools/* cmdline-tools/latest/ || true
          fi
          export PATH="${SDK_ROOT}/cmdline-tools/latest/bin:${SDK_ROOT}/platform-tools:${PATH}"
          yes | sdkmanager --sdk_root="${SDK_ROOT}" --licenses
          sdkmanager --sdk_root="${SDK_ROOT}" "platform-tools" "platforms;android-33" "build-tools;33.0.2"

      - name: Ensure sdkmanager in PATH for remaining steps
        run: |
          export PATH="${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin:${ANDROID_SDK_ROOT}/platform-tools:${PATH}"
          sdkmanager --list

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build Debug APK (assembleDebug)
        run: ./gradlew assembleDebug --no-daemon

      - name: Optional: Build Release APK if keystore secrets provided
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          set -e
          echo "Found KEYSTORE_BASE64 secret — building signed release APK"
          echo "$KEYSTORE_BASE64" | base64 --decode > release-keystore.jks
          # 调用 Gradle 构建 signed release：以项目的 signing 配置为准（下面使用注入参数的方式）
          ./gradlew assembleRelease -Pandroid.injected.signing.storeFile=$(pwd)/release-keystore.jks \
            -Pandroid.injected.signing.storePassword="$KEYSTORE_PASSWORD" \
            -Pandroid.injected.signing.keyAlias="$KEY_ALIAS" \
            -Pandroid.injected.signing.keyPassword="$KEY_PASSWORD" --no-daemon

      - name: Collect APKs and upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk-artifacts
          path: |
            app/build/outputs/**/*.apk
            **/build/outputs/**/*.apk

      - name: Show build output paths (debug)
        run: ls -R app/build/outputs || true
