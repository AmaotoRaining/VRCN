name: Build Debug APK

on:
  push:  # Automatically triggers on code pushes to specified branches
    branches: [ main, develop ]  # Customize branches if needed; triggers on push to these
  pull_request:  # Also triggers on PRs for CI validation
    branches: [ main ]
  workflow_dispatch:  # Retains manual triggering from GitHub UI

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      # Automatically accepts all Android SDK licenses (including NDK) via default 'accept-android-sdk-licenses: yes'.
      # Installs cmdline-tools, ensuring sdkmanager is available; sets ANDROID_SDK_ROOT and PATH for Flutter/Gradle.

    - name: Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.0'  # Latest stable (Nov 2025) with Dart 3.10, satisfying ^3.7.2
        channel: 'stable'
        cache: true  # Caches Flutter pub dependencies automatically

    - name: Get Flutter dependencies
      run: flutter pub get

    - name: Create key.properties for debug signing
      run: |
        cat > android/key.properties << 'EOF'
        storePassword=android
        keyPassword=android
        keyAlias=androiddebugkey
        storeFile=~/.android/debug.keystore
        EOF
      # This provides the required properties file for the project's signing config.
      # In CI, key.properties may not exist, causing null cast errors when loading properties like keyAlias.

    - name: Build debug APK
      run: flutter build apk --debug --flavor debug
      # Uses default debug keystore for signing in CI environmentâ€”no custom keystore needed.
      # Flavor 'debug' as per README instructions ensures correct configuration.
      # Output: build/app/outputs/flutter-apk/app-debug.apk (installable on Android devices with unknown sources enabled).

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: vrcn-debug-apk-${{ github.sha }}  # Includes commit SHA for versioning (manual runs use run_id)
        path: build/app/outputs/flutter-apk/app-debug.apk
        retention-days: 30  # Artifacts available for 30 days in GitHub CI
